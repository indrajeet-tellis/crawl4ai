version: '3.8'

# Shared configuration for all environments
x-base-config: &base-config
  ports:
    - "11235:11235" # Gunicorn port
  # env_file:
  #   - .llm.env # API keys (create from .llm.env.example)
  # Uncomment to set default environment variables (will overwrite .llm.env)
  environment:
    - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-https://api.z.ai/api/anthropic}
    - LLM_PROVIDER=${LLM_PROVIDER:-anthropic/glm-4.7}
  volumes:
    - /dev/shm:/dev/shm # Chromium performance
  deploy:
    resources:
      limits:
        memory: 4G
      reservations:
        memory: 1G
  restart: unless-stopped
  healthcheck:
    test: [ "CMD", "curl", "-f", "http://localhost:11235/health" ]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 40s
  user: "appuser"

services:
  crawl4ai:
    # 1. Default: Pull multi-platform test image from Docker Hub
    # 2. Override with local image via: IMAGE=local-test docker compose up
    image: ${IMAGE:-unclecode/crawl4ai:${TAG:-latest}}

    # Local build config (used with --build)
    build:
      context: .
      dockerfile: Dockerfile
      args:
        INSTALL_TYPE: ${INSTALL_TYPE:-default}
        ENABLE_GPU: ${ENABLE_GPU:-false}

    # Inherit shared config
    <<: *base-config
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.crawl4ai.rule=Host(`scrape.always.click`)"
      - "traefik.http.routers.crawl4ai.entrypoints=websecure"
      - "traefik.http.routers.crawl4ai.tls.certresolver=letsencrypt"
      - "traefik.http.services.crawl4ai.loadbalancer.server.port=11235"
      - "dokploy.expose=true"
